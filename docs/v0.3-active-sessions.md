# v0.3 Plan: Active Sessions with Embedded Terminal

## Goal

Add embedded VTE terminal for interactive Claude Code sessions, with tab switching between Terminal and History views.

## Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│  Claude Companion                                               │
├─────────────────────────────────────────────────────────────────┤
│  ┌──────────────────┐  ┌──────────────────────────────────────┐ │
│  │ Projects         │  │ [Terminal]  [History]                │ │
│  ├──────────────────┤  ├──────────────────────────────────────┤ │
│  │                  │  │                                      │ │
│  │ > my-project     │  │  $ claude                            │ │
│  │   other-project  │  │  > Fix the login bug                 │ │
│  │                  │  │                                      │ │
│  │                  │  │  I'll analyze the auth module...     │ │
│  │                  │  │                                      │ │
│  └──────────────────┘  └──────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## Key Features

1. **Embedded VTE terminal** — full Claude CLI interactivity
2. **Tab switcher** — Terminal / History views
3. **Project-aware** — terminal `cd`s to selected project directory
4. **History auto-refresh** — updates when switching to History tab

## Dependencies

```bash
# Fedora
sudo dnf install vte291-gtk4-devel

# For Python
# vte-2.91-gtk4 via gi.repository
```

## Checkpoints

### Checkpoint 1: Add VTE dependency and basic terminal
- [x] Verify VTE GTK4 availability
- [x] Create `TerminalView` widget wrapping `Vte.Terminal`
- [x] Spawn default shell in terminal
- [x] Basic terminal functionality (input, output, colors)

### Checkpoint 2: Tab-based UI
- [x] Add `Adw.ViewStack` for Terminal/History tabs
- [x] Add `Adw.ViewSwitcher` in header bar
- [x] Move existing session view to History tab
- [x] Add TerminalView to Terminal tab

### Checkpoint 3: Project integration
- [x] On project selection, `cd` to project directory in terminal
- [ ] Optionally auto-run `claude` command
- [ ] Show project path in terminal tab header

### Checkpoint 4: History refresh
- [x] Refresh session list when switching to History tab
- [x] Detect new sessions created during terminal use
- [ ] Update session count in sidebar

### Checkpoint 5: Polish
- [ ] Terminal color scheme matching app theme
- [x] Copy/paste support in terminal (native VTE)
- [x] Font configuration (default scale 1.0)
- [x] Handle terminal exit/respawn

## File Structure

```
src/
├── widgets/
│   ├── terminal_view.py   # NEW: VTE terminal wrapper
│   └── ...
└── window.py              # Update with tabs
```

## VTE GTK4 Usage

```python
import gi
gi.require_version('Vte', '3.91')  # GTK4 version
from gi.repository import Vte, GLib

terminal = Vte.Terminal()
terminal.spawn_async(
    Vte.PtyFlags.DEFAULT,
    working_directory,  # Project path
    ["/bin/bash"],      # Or user's shell
    None,               # Environment
    GLib.SpawnFlags.DEFAULT,
    None, None,         # Child setup
    -1,                 # Timeout
    None,               # Cancellable
    None                # Callback
)
```

## Questions Resolved

- ✅ Full interactivity via real terminal
- ✅ All Claude features work (y/n prompts, etc.)
- ✅ Familiar terminal experience
- ✅ History view preserved with nice UI

## Progress

- Started: 2025-12-11
- Completed: 2025-12-11
- Status: COMPLETE (core features)
