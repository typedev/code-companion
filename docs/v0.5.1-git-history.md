# v0.5.1 Plan: Git History & Sidebar Refactor

## Goal

Restructure sidebar into Files/Git tabs, add commit history view with checkout/reset/revert operations.

## UI Design

### Sidebar Structure

```
┌─────────────────────────┐
│ [Files] [Git]           │  ← Gtk.StackSwitcher (top level)
└─────────────────────────┘

Files tab:
┌─────────────────────────┐
│ (refresh button)     ⟳  │
├─────────────────────────┤
│ ▶ src/                  │
│ ▶ docs/                 │
│   main.py               │
│   README.md             │
├─────────────────────────┤
│ Tasks                ⟳  │
│ [▶] Run App             │
│ [▶] Build               │
└─────────────────────────┘

Git tab:
┌─────────────────────────┐
│ [Changes] [History]     │  ← nested Gtk.StackSwitcher
└─────────────────────────┘
```

### Changes Panel (existing, minor updates)

```
┌─────────────────────────┐
│ ● main              ⟳   │
├─────────────────────────┤
│ Staged (2)          [-] │
│   ✓ file1.py        [-] │
├─────────────────────────┤
│ Changes (3)         [+] │
│   M file2.py        [+] │
├─────────────────────────┤
│ [____commit msg_______] │
│ [Commit] [Pull] [Push]  │
└─────────────────────────┘
```

### History Panel (new)

```
┌─────────────────────────┐
│ Commits             ⟳   │
├─────────────────────────┤
│ ● abc1234             │ │  ← current HEAD
│ │ Fix critical bug      │
│ │ Alexander · 2h ago    │
│ ├─────────────────────┤ │
│ ○ def5678               │
│ │ Add new feature       │
│ │ Alexander · yesterday │
│ ├─────────────────────┤ │
│ ○ 789abcd               │
│ │ Initial commit        │
│ │ Alexander · 3 days    │
└─────────────────────────┘

Right-click / select commit:
  • View diff
  • Checkout
  • Reset (soft)
  • Reset (hard)
  • Revert
```

### Commit Row Design

```
┌─────────────────────────────┐
│ ● abc1234                   │  ← ● for HEAD, ○ for others
│   Fix critical bug          │  ← commit message (first line)
│   Alexander · 2 hours ago   │  ← author · relative time
└─────────────────────────────┘
```

## File Changes

```
src/
├── widgets/
│   ├── git_panel.py       # UPDATE: extract to git_changes_panel.py
│   ├── git_changes_panel.py  # NEW: renamed from git_panel.py
│   ├── git_history_panel.py  # NEW: commit history list
│   └── sidebar.py         # NEW: Files/Git tab container
├── services/
│   └── git_service.py     # UPDATE: add history methods
└── project_window.py      # UPDATE: use new Sidebar widget
```

## Checkpoints

### Checkpoint 1: Refactor sidebar structure
- [ ] Create Sidebar widget with Files/Git tabs
- [ ] Move FileTree + TasksPanel into Files tab
- [ ] Move GitPanel into Git tab (as Changes sub-tab)
- [ ] Update ProjectWindow to use new Sidebar

### Checkpoint 2: Git service history methods
- [ ] `get_commits(limit=50)` — list recent commits
- [ ] `get_commit_diff(commit_hash)` — diff for a commit
- [ ] `checkout_commit(commit_hash)` — checkout (detached HEAD)
- [ ] `reset_to_commit(commit_hash, mode='soft'|'hard')` — reset
- [ ] `revert_commit(commit_hash)` — create revert commit

### Checkpoint 3: History panel UI
- [ ] Create GitHistoryPanel widget
- [ ] Display commit list with hash, message, author, time
- [ ] Highlight current HEAD commit
- [ ] Add refresh button

### Checkpoint 4: Commit actions
- [ ] Click commit → show diff in new tab
- [ ] Right-click menu or action buttons
- [ ] Checkout confirmation dialog
- [ ] Reset confirmation dialog (warn about hard reset)
- [ ] Revert execution

### Checkpoint 5: Nested tabs in Git
- [ ] Add Changes/History sub-tabs in Git tab
- [ ] Preserve state when switching tabs

## Implementation Details

### GitService additions

```python
@dataclass
class GitCommit:
    hash: str
    short_hash: str
    message: str
    author: str
    author_email: str
    timestamp: datetime
    is_head: bool

class GitService:
    # Existing methods...

    def get_commits(self, limit: int = 50) -> list[GitCommit]:
        """Get recent commits from current branch."""

    def get_commit_diff(self, commit_hash: str) -> tuple[str, str]:
        """Get diff between commit and its parent."""

    def checkout_commit(self, commit_hash: str) -> None:
        """Checkout a specific commit (detached HEAD)."""

    def reset_to_commit(self, commit_hash: str, hard: bool = False) -> None:
        """Reset current branch to commit."""

    def revert_commit(self, commit_hash: str) -> str:
        """Create a revert commit, return new commit hash."""
```

### GitHistoryPanel

```python
class GitHistoryPanel(Gtk.Box):
    __gsignals__ = {
        "commit-selected": (GObject.SignalFlags.RUN_FIRST, None, (str,)),  # hash
        "checkout-requested": (GObject.SignalFlags.RUN_FIRST, None, (str,)),
        "reset-requested": (GObject.SignalFlags.RUN_FIRST, None, (str, bool)),  # hash, hard
        "revert-requested": (GObject.SignalFlags.RUN_FIRST, None, (str,)),
    }
```

### Sidebar widget

```python
class Sidebar(Gtk.Box):
    """Sidebar with Files/Git top-level tabs."""

    __gsignals__ = {
        "file-activated": ...,
        "task-run": ...,
        "git-file-clicked": ...,
        "commit-selected": ...,
        ...
    }

    def __init__(self, project_path: str, git_service: GitService | None):
        # Top-level stack: Files / Git
        # Git has nested stack: Changes / History
```

## Relative Time Format

| Time diff | Display |
|-----------|---------|
| < 1 min | "just now" |
| < 60 min | "X minutes ago" |
| < 24 hours | "X hours ago" |
| < 7 days | "X days ago" |
| < 30 days | "X weeks ago" |
| else | "Mon DD, YYYY" |

## Progress

- Started: 2025-01-XX
- Current checkpoint: 5 (all complete)
- Status: COMPLETED

All checkpoints implemented:
- [x] Sidebar refactored to Files/Git top-level tabs
- [x] GitService history methods (get_commits, checkout, reset, revert)
- [x] GitHistoryPanel with commit list and relative time
- [x] Commit actions with confirmation dialogs
- [x] Nested Changes/History tabs in Git
