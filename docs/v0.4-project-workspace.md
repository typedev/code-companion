# v0.4 Plan: Project Workspace

## Goal

Restructure the application into a two-window architecture with full project workspace functionality.

## Architecture

### Multi-instance Design

```python
app = Adw.Application(
    application_id="com.github.typedev.claude-companion",
    flags=Gio.ApplicationFlags.NON_UNIQUE  # Each project = separate process
)
```

- Each project runs in its own process
- Isolation: crash in one doesn't affect others
- Memory freed when project closed
- Lock file prevents opening same project twice

### Window Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Project Manager   â”‚
â”‚                     â”‚
â”‚  > my-project       â”‚â”€â”€â”€â”€â”€â”€>  [New Process] Project Window (my-project)
â”‚    other-project    â”‚
â”‚                     â”‚â”€â”€â”€â”€â”€â”€>  [New Process] Project Window (other-project)
â”‚  [+ Open Folder]    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Project Manager Window

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Claude Companion                            [â€”][Ã—] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ğŸ“ my-project                      12 sessionsâ”‚  â”‚
â”‚  â”‚    ~/projects/my-project                      â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ ğŸ“ other-project                   5 sessions â”‚  â”‚
â”‚  â”‚    ~/work/other-project                   [Ã—] â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ ğŸ“ new-project                     0 sessions â”‚  â”‚
â”‚  â”‚    ~/new-project                          [Ã—] â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                     â”‚
â”‚  [+ Open Folder]                                    â”‚
â”‚                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

Features:
- List projects from `~/.claude/projects/` + manually added
- Show session count per project
- "Open Folder" button to add new project (registers it)
- Delete button [Ã—] only for projects with 0 sessions
- Double-click or Enter opens Project Window (new process)
- Stays open after opening project (can be closed manually)

## Project Window

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [Claude ğŸŸ¢]  [+ Terminal]                        ~/my-project [Ã—]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“ Files        â”‚ [History] [Claude Ã—] [main.py Ã—] [Terminal 2 Ã—]   â”‚
â”‚ â”œâ”€â”€ ğŸ“ src/     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”‚   â”œâ”€â”€ main.py â”‚                                                   â”‚
â”‚ â”‚   â””â”€â”€ ğŸ“ utilsâ”‚                                                   â”‚
â”‚ â”œâ”€â”€ ğŸ“ tests/   â”‚            < Tab Content >                        â”‚
â”‚ â”œâ”€â”€ config.yaml â”‚                                                   â”‚
â”‚ â””â”€â”€ README.md   â”‚                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Header Bar

- **Claude button**: Opens Claude terminal tab, runs `claude` command
  - ğŸŸ¢ Active: no Claude tab open
  - ğŸ”´ Disabled: Claude tab already exists
- **+ Terminal button**: Opens new terminal tab in project directory
- **Title**: Project path

### Sidebar (File Tree)

- Shows all files/folders except `.git`
- Expandable/collapsible directories
- Double-click file â†’ opens in new tab (or focuses existing tab)
- Icons for files/folders

### Tab View

**Tab Types:**

1. **History** (pinned)
   - Cannot be closed
   - Shows session list â†’ session detail (existing functionality)

2. **Claude Terminal** (max 1)
   - Created by Claude button
   - Runs `cd <project> && claude`
   - Close warning: "Claude session is active. Close anyway?"
   - When closed â†’ Claude button becomes active again

3. **Terminal N** (unlimited)
   - Created by + Terminal button
   - Starts shell in project directory
   - Can be closed freely

4. **File Tabs** (unlimited)
   - Created by double-clicking file in tree
   - GtkSourceView with syntax highlighting
   - Editable with undo/redo
   - Auto-save on focus loss
   - Modified indicator (dot or *)
   - Close freely (auto-saved)

## File Structure

```
src/
â”œâ”€â”€ app.py                    # Application entry, NON_UNIQUE
â”œâ”€â”€ project_manager.py        # Project Manager window
â”œâ”€â”€ project_window.py         # Project Window (replaces window.py)
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ project.py           # Add: is_registered, can_delete
â”‚   â””â”€â”€ ...
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ history.py
â”‚   â”œâ”€â”€ project_registry.py  # NEW: manage registered projects
â”‚   â””â”€â”€ ...
â”œâ”€â”€ widgets/
â”‚   â”œâ”€â”€ file_tree.py         # NEW: file tree sidebar
â”‚   â”œâ”€â”€ file_editor.py       # NEW: editable code view
â”‚   â”œâ”€â”€ tab_terminal.py      # NEW: terminal in tab
â”‚   â”œâ”€â”€ tab_history.py       # NEW: history view as tab
â”‚   â”œâ”€â”€ session_view.py
â”‚   â”œâ”€â”€ code_view.py
â”‚   â””â”€â”€ ...
â””â”€â”€ utils/
    â””â”€â”€ ...
```

## Checkpoints

### Checkpoint 1: Application restructure
- [x] Change to NON_UNIQUE application
- [x] Create ProjectManagerWindow class
- [x] Create ProjectWindow class (refactor from MainWindow)
- [x] Implement project opening (spawn new process)
- [x] Add lock file to prevent duplicate project opening

### Checkpoint 2: Project Manager
- [x] List projects from ~/.claude/projects/
- [x] Add "Open Folder" functionality
- [x] Project registry service (remember manually added projects)
- [x] Delete button for empty projects
- [x] Launch Project Window on selection

### Checkpoint 3: Project Window - Tab system
- [x] Replace ViewStack with Adw.TabView + TabBar
- [x] Implement pinned History tab
- [x] Terminal tabs (reuse TerminalView)
- [x] Claude button logic (enable/disable, spawn claude)

### Checkpoint 4: File Tree
- [x] Create FileTree widget
- [x] Recursive directory listing
- [x] Filter out .git
- [x] Expand/collapse directories
- [x] File/folder icons
- [x] Double-click to open file

### Checkpoint 5: File Editor
- [x] Create FileEditor widget (based on CodeView)
- [x] Enable editing
- [x] Undo/redo support
- [x] Auto-save on focus loss
- [x] Modified indicator
- [x] Open files as tabs

### Checkpoint 6: Polish
- [x] Close warning for active Claude session
- [x] Tab tooltips (full path for files)
- [ ] Keyboard shortcuts
- [ ] Remember window size/position

## Technical Details

### Lock File

```python
# In project_window.py
lock_path = Path(f"/tmp/claude-companion-{project_hash}.lock")
if lock_path.exists():
    # Show error: project already open
    return
lock_path.touch()
# On window close: lock_path.unlink()
```

### Project Registry

```python
# ~/.config/claude-companion/projects.json
{
    "registered_projects": [
        "/home/user/my-project",
        "/home/user/other-project"
    ]
}
```

### Spawning New Process

```python
def open_project(project_path: str):
    subprocess.Popen(
        ["claude-companion", "--project", project_path],
        start_new_session=True
    )
```

### Auto-save

```python
class FileEditor(GtkSource.View):
    def __init__(self):
        # ...
        focus_controller = Gtk.EventControllerFocus()
        focus_controller.connect("leave", self._on_focus_leave)
        self.add_controller(focus_controller)

    def _on_focus_leave(self, controller):
        if self.is_modified:
            self.save()
```

## Dependencies

No new dependencies required. Uses:
- Adw.TabView, Adw.TabBar (libadwaita)
- GtkSource.View (gtksourceview-5)
- Vte.Terminal (vte-2.91-gtk4)
- Gio.File, Gio.FileEnumerator (file tree)

## Progress

- Started: 2025-12-11
- Current checkpoint: 5 complete
- Status: MOSTLY COMPLETE
