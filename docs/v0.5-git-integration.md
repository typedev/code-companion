# v0.5 Plan: Git Integration

## Goal

Add git integration — view changes, stage/unstage files, commit, push/pull, show diffs.

## Dependencies

```toml
# pyproject.toml
dependencies = [
    ...
    "pygit2>=1.13.0",
]
```

## UI Design

### Sidebar with Tabs

```
┌─────────────────────────┐
│ [Files] [Changes]       │  ← Gtk.StackSwitcher
├─────────────────────────┤
│ (active tab content)    │
└─────────────────────────┘
```

### Changes Tab

```
┌─────────────────────────┐
│ ● main              ⟳   │  ← current branch + refresh
├─────────────────────────┤
│ Staged (2)          [-] │  ← unstage all
│   ✓ file1.py        [-] │
│   ✓ file2.py        [-] │
├─────────────────────────┤
│ Changes (3)         [+] │  ← stage all
│   M modified.py     [+] │
│   ? untracked.py    [+] │
│   D deleted.py      [+] │
├─────────────────────────┤
│ [____Commit message___] │
│ [Commit] [Pull] [Push]  │
└─────────────────────────┘
```

### Color Coding

| Status | Color | CSS Class |
|--------|-------|-----------|
| Modified (M) | yellow `#f1c40f` | `git-modified` |
| Added/Untracked (A/?) | green `#2ecc71` | `git-added` |
| Deleted (D) | red `#e74c3c` | `git-deleted` |
| Renamed (R) | blue `#3498db` | `git-renamed` |

Colors applied to:
- Status letter in Changes panel
- File name in Changes panel
- Dot indicator in FileTree for changed files

### Diff View

Click file in Changes panel → opens diff in new tab using existing DiffView widget.

## File Structure

```
src/
├── widgets/
│   ├── git_panel.py       # NEW: Changes panel with stage/commit
│   ├── file_tree.py       # UPDATE: add git status indicators
│   └── ...
├── services/
│   └── git_service.py     # NEW: pygit2 wrapper
└── project_window.py      # UPDATE: sidebar tabs (Files/Changes)
```

## Checkpoints

### Checkpoint 1: GitService basics
- [ ] Add pygit2 dependency
- [ ] Create GitService class
- [ ] Detect if directory is git repo
- [ ] Get current branch name
- [ ] Get file statuses (modified, staged, untracked, deleted)

### Checkpoint 2: Changes panel UI
- [ ] Create GitPanel widget
- [ ] Display current branch
- [ ] List staged files
- [ ] List changed/untracked files
- [ ] Color coding for statuses

### Checkpoint 3: Sidebar tabs
- [ ] Refactor sidebar to use Gtk.Stack
- [ ] Add Files/Changes tab switcher
- [ ] Show Changes tab only for git repos
- [ ] Hide Changes tab if not a git repo

### Checkpoint 4: Stage/Unstage
- [ ] Stage individual file (click [+])
- [ ] Unstage individual file (click [-])
- [ ] Stage all changes
- [ ] Unstage all
- [ ] Refresh after operations

### Checkpoint 5: Commit
- [ ] Commit message entry field
- [ ] Commit button (disabled if no staged or empty message)
- [ ] Execute commit via pygit2
- [ ] Show success/error toast

### Checkpoint 6: Diff view
- [ ] Click file → get diff content
- [ ] Open in new tab with DiffView
- [ ] Handle new files (show full content as added)
- [ ] Handle deleted files (show full content as removed)

### Checkpoint 7: Push/Pull
- [ ] Pull button with system credentials
- [ ] Push button with system credentials
- [ ] Handle credential errors gracefully
- [ ] Show progress/result in toast

### Checkpoint 8: FileTree git indicators
- [ ] Add git status to FileTree rows
- [ ] Show colored dot for modified files
- [ ] Update on git operations
- [ ] Efficient status caching

## Implementation Details

### GitService

```python
import pygit2
from pathlib import Path
from dataclasses import dataclass
from enum import Enum

class FileStatus(Enum):
    MODIFIED = "M"
    ADDED = "A"
    DELETED = "D"
    RENAMED = "R"
    UNTRACKED = "?"

@dataclass
class GitFileStatus:
    path: str
    status: FileStatus
    staged: bool

class GitService:
    def __init__(self, repo_path: Path):
        self.repo_path = repo_path
        self._repo: pygit2.Repository | None = None

    def is_git_repo(self) -> bool:
        """Check if path is inside a git repository."""

    def open(self) -> bool:
        """Open the repository."""

    def get_branch_name(self) -> str:
        """Get current branch name."""

    def get_status(self) -> list[GitFileStatus]:
        """Get status of all changed files."""

    def stage(self, path: str) -> None:
        """Stage a file."""

    def unstage(self, path: str) -> None:
        """Unstage a file."""

    def commit(self, message: str) -> str:
        """Create commit, return commit hash."""

    def pull(self) -> None:
        """Pull from remote."""

    def push(self) -> None:
        """Push to remote."""

    def get_diff(self, path: str, staged: bool = False) -> str:
        """Get diff for a file."""
```

### GitPanel

```python
class GitPanel(Gtk.Box):
    __gsignals__ = {
        "file-clicked": (GObject.SignalFlags.RUN_FIRST, None, (str, bool)),  # path, staged
    }

    def __init__(self, project_path: str):
        self.service = GitService(project_path)
        self._build_ui()
        self.refresh()
```

### CSS for colors

```css
.git-modified { color: #f1c40f; }
.git-added { color: #2ecc71; }
.git-deleted { color: #e74c3c; }
.git-renamed { color: #3498db; }
```

### Credentials handling

pygit2 uses callbacks for authentication:

```python
def credentials_callback(url, username_from_url, allowed_types):
    if allowed_types & pygit2.GIT_CREDENTIAL_SSH_KEY:
        return pygit2.Keypair(username_from_url,
                              str(Path.home() / ".ssh/id_rsa.pub"),
                              str(Path.home() / ".ssh/id_rsa"),
                              "")
    elif allowed_types & pygit2.GIT_CREDENTIAL_USERPASS_PLAINTEXT:
        # Try git credential helper
        return pygit2.Username(username_from_url)
    return None
```

## Progress

- Started: 2025-01-XX
- Current checkpoint: 8 (all complete)
- Status: COMPLETED

All checkpoints implemented:
- [x] GitService with pygit2 for all git operations
- [x] GitPanel widget with staged/unstaged file lists
- [x] Sidebar with Files/Changes tabs (Gtk.Stack)
- [x] Stage/unstage individual files and all
- [x] Commit with message entry
- [x] Diff view opens in new tab on file click
- [x] Push/Pull with SSH key credentials
- [x] FileTree shows colored indicators for changed files
