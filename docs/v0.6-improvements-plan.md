# v0.6 Improvements Plan

**Status**: In Progress
**Created**: 2025-12-12

---

## Overview

This plan covers critical improvements identified during codebase analysis. Organized by priority with checkpoints for each feature.

---

## Phase 1: Foundation & Feedback (High Priority)

### 1.1 Toast Notification System ✅ COMPLETED
**Goal**: Provide user feedback for all operations

**Current state**: ~~Multiple `TODO` comments, operations just `print()` to console~~ DONE

**Implementation**:
- [x] **CP1.1.1**: Add `Adw.ToastOverlay` to `ProjectWindow`
- [x] **CP1.1.2**: Create `ToastService` singleton for app-wide access
- [x] **CP1.1.3**: Replace git operation prints with toasts (git_changes_panel.py, git_history_panel.py)
- [x] **CP1.1.4**: Add toasts for file operations (save, error, etc.)
- [x] **CP1.1.5**: Add toasts for terminal errors

**Files to modify**:
- `src/project_window.py` - add ToastOverlay wrapper
- `src/services/toast_service.py` - new file
- `src/widgets/git_changes_panel.py` - replace prints
- `src/widgets/git_history_panel.py` - replace prints
- `src/widgets/file_editor.py` - add save confirmation

**Estimate**: Small, 1-2 hours

---

### 1.2 File System Watching ✅ COMPLETED
**Goal**: Auto-refresh file tree when files change

**Current state**: ~~Manual refresh only, poor DX~~ DONE

**Implementation**:
- [x] **CP1.2.1**: Add `Gio.FileMonitor` with `WATCH_MOVES` flag to `FileTree`
- [x] **CP1.2.2**: Implement debounced refresh (300ms) to batch rapid changes
- [x] **CP1.2.3**: Preserve expansion state during auto-refresh
- [x] **CP1.2.4**: Preserve scroll position during auto-refresh
- [x] **CP1.2.5**: Add monitoring for expanded directories (dynamic)
- [x] **CP1.2.6**: Cleanup monitors on widget destroy

**Files modified**:
- `src/widgets/file_tree.py` - added file monitoring

**Estimate**: ~~Medium, 2-3 hours~~ DONE

---

### 1.3 File Tree Filtering ✅ COMPLETED
**Goal**: Hide irrelevant files (node_modules, __pycache__, .venv, etc.)

**Current state**: ~~Only `.git` is hardcoded hidden~~ DONE

**Implementation**:
- [x] **CP1.3.1**: Parse `.gitignore` files using `pathspec` library
- [x] **CP1.3.2**: Add default ignore patterns list (node_modules, __pycache__, .venv, etc.)
- [x] **CP1.3.3**: Add toggle button "Show ignored files" in file tree header
- [ ] **CP1.3.4**: Store preference in settings (deferred to Phase 4)

**Files modified**:
- `src/widgets/file_tree.py` - filtering logic with pathspec
- `src/project_window.py` - toggle button
- `pyproject.toml` - added pathspec dependency

**Estimate**: ~~Small-Medium, 1-2 hours~~ DONE

---

## Phase 2: Git Enhancements (High Priority)

### 2.1 Branch Management ✅ COMPLETED
**Goal**: Create, switch, delete branches from UI

**Current state**: ~~Only shows current branch name, checkout creates detached HEAD~~ DONE

**Implementation**:
- [x] **CP2.1.1**: Add `list_branches()` to `GitService` (local + remote)
- [x] **CP2.1.2**: Add `create_branch(name, from_ref=None)` to `GitService`
- [x] **CP2.1.3**: Add `switch_branch(name)` to `GitService` (proper checkout, not detached)
- [x] **CP2.1.4**: Add `delete_branch(name, force=False)` to `GitService`
- [x] **CP2.1.5**: Create `BranchPopover` widget with branch list
- [x] **CP2.1.6**: Add "New branch" button with name entry dialog
- [x] **CP2.1.7**: Add branch switching from popover (with uncommitted changes warning)
- [x] **CP2.1.8**: Add branch deletion with confirmation
- [ ] **CP2.1.9**: Show remote tracking info (ahead/behind) - deferred

**Files to modify**:
- `src/services/git_service.py` - add methods
- `src/widgets/branch_popover.py` - new file
- `src/widgets/git_changes_panel.py` - replace branch label with button+popover

**UI Mockup**:
```
[main ▼]  <- clickable button
┌─────────────────────────┐
│ Branches                │
├─────────────────────────┤
│ ● main (current)        │
│   feature/new-ui        │
│   fix/bug-123           │
├─────────────────────────┤
│ Remote                  │
│   origin/main           │
│   origin/develop        │
├─────────────────────────┤
│ [+ New branch]          │
└─────────────────────────┘
```

**Estimate**: Medium, 3-4 hours

---

### 2.2 Commit Details View ✅ COMPLETED
**Goal**: View full commit info with file list and per-file diffs

**Current state**: ~~Only unified diff for entire commit, no file breakdown~~ DONE

**Implementation**:
- [x] **CP2.2.1**: Add `get_commit_files(sha)` to `GitService` returning changed files with stats
- [x] **CP2.2.2**: Add `get_commit_file_diff(sha, file_path)` to `GitService`
- [x] **CP2.2.3**: Create `CommitDetailView` widget:
  - Header: SHA, author, date (compact)
  - Horizontal split: files list (left), full commit message (right)
  - Diff view at bottom for selected file
- [x] **CP2.2.4**: Integrate into git history panel (click commit row to open details)
- [x] **CP2.2.5**: Add "Copy SHA" button
- [x] **CP2.2.6**: Reuse single tab for commit details (no duplicate tabs)
- [ ] **CP2.2.7**: Add "Browse files at this commit" option (optional, deferred)

**Files modified**:
- `src/services/git_service.py` - added methods
- `src/widgets/commit_detail_view.py` - new file
- `src/widgets/git_history_panel.py` - integrated new view

**UI Layout**:
```
┌─────────────────────────────────────────────────────────────┐
│ abc1234 [copy] · Author · 2025-12-10 14:30                  │  <- Header
├──────────────────────────┬──────────────────────────────────┤
│ Files (3)                │  Message                         │
│ ┌──────────────────────┐ │  ┌────────────────────────────┐  │
│ │ M auth.py      +10-5 │ │  │ Fix authentication bug     │  │  <- Horizontal split
│ │ A token.py     +25   │ │  │                            │  │
│ │ D old_auth.py  -100  │ │  │ Full commit message body   │  │
│ └──────────────────────┘ │  │ with multiple lines...     │  │
│                          │  └────────────────────────────┘  │
├──────────────────────────┴──────────────────────────────────┤
│ Diff view for selected file                                 │  <- Bottom
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**Estimate**: Medium, 3-4 hours

---

### 2.3 Improved Diff View
**Goal**: Better diff visualization with file navigation

**Current state**: Raw unified diff text, no structure

**Implementation**:
- [ ] **CP2.3.1**: Refactor `DiffView` to support multiple modes:
  - Unified diff (current)
  - Split view (side-by-side)
  - File-by-file navigation
- [ ] **CP2.3.2**: Add syntax highlighting to diff (use GtkSourceView)
- [ ] **CP2.3.3**: Add line number gutters for both sides
- [ ] **CP2.3.4**: Add +/- color coding (green/red backgrounds)
- [ ] **CP2.3.5**: Add "Previous/Next change" navigation buttons
- [ ] **CP2.3.6**: Add "Previous/Next file" navigation for multi-file diffs

**Files to modify**:
- `src/widgets/code_view.py` - enhance DiffView class
- `src/resources/style.css` - diff colors

**Estimate**: Medium-Large, 4-5 hours

---

### 2.4 Pull with Merge Support
**Goal**: Handle non-fast-forward pulls

**Current state**: Only fast-forward, fails on merge needed

**Implementation**:
- [ ] **CP2.4.1**: Detect merge-needed situation in `git_pull()`
- [ ] **CP2.4.2**: Implement automatic merge commit creation
- [ ] **CP2.4.3**: Detect and report merge conflicts
- [ ] **CP2.4.4**: Create `ConflictResolutionView` for conflict files (optional, complex)
- [ ] **CP2.4.5**: Add "Abort merge" button when in conflict state

**Files to modify**:
- `src/services/git_service.py` - enhance pull logic
- `src/widgets/git_changes_panel.py` - conflict UI
- `src/widgets/conflict_view.py` - new file (optional)

**Considerations**:
- Merge conflicts are complex UX problem
- Minimum viable: show conflict markers in editor, let user resolve manually
- Advanced: 3-way merge editor (very complex)

**Estimate**: Medium for basic, Large for conflict resolution

---

## Phase 3: Search & Navigation (Medium Priority)

### 3.1 File Search (Fuzzy Finder) ✅ COMPLETED
**Goal**: Quick file navigation by name

**Implementation**:
- [x] **CP3.1.1**: Create `FileSearchDialog` with search entry
- [x] **CP3.1.2**: Implement fuzzy matching algorithm (custom scoring algorithm)
- [x] **CP3.1.3**: File list collected on-demand from project
- [x] **CP3.1.4**: Show results with filename and path
- [x] **CP3.1.5**: Keyboard navigation (up/down/enter/escape)
- [x] **CP3.1.6**: Add Ctrl+P shortcut to open dialog
- [x] **CP3.1.7**: Respect gitignore for results (uses FileTree's `_is_ignored()`)

**Files created**:
- `src/widgets/file_search_dialog.py`
- `src/project_window.py` - added Ctrl+P shortcut and integration

**Fuzzy scoring**:
- Exact filename match: +1000
- Filename starts with query: +100
- Filename contains query: +50
- Path contains query: +20
- Sequential character match: +10 per char + consecutive bonus
- Files sorted by score, limited to 50 results

---

### 3.2 Content Search (Grep) ✅ COMPLETED
**Goal**: Search text across all files with find & replace

**Implementation**:
- [x] **CP3.2.1**: Create `ContentSearchDialog` as popup
- [x] **CP3.2.2**: Implement search using `ripgrep` subprocess
- [x] **CP3.2.3**: Show results grouped by file with line numbers
- [x] **CP3.2.4**: Click result -> open file at line
- [x] **CP3.2.5**: Add regex toggle
- [x] **CP3.2.6**: Add case-sensitive toggle
- [x] **CP3.2.7**: Add whole word toggle
- [x] **CP3.2.8**: Add include/exclude file pattern filters
- [x] **CP3.2.9**: Add Replace All functionality
- [x] **CP3.2.10**: Add Ctrl+Shift+F shortcut and button

**Files created**:
- `src/widgets/content_search_dialog.py`
- `src/widgets/file_editor.py` - added `go_to_line()` method
- `src/project_window.py` - added shortcut and integration

---

### 3.3 Session History Search
**Goal**: Find past conversations and tool uses

**Implementation**:
- [ ] **CP3.3.1**: Add search entry to history panel
- [ ] **CP3.3.2**: Implement full-text search across session content
- [ ] **CP3.3.3**: Add filter by date range
- [ ] **CP3.3.4**: Add filter by tool type (Edit, Bash, Read, etc.)
- [ ] **CP3.3.5**: Highlight matches in results
- [ ] **CP3.3.6**: Add export session to markdown

**Files to modify**:
- `src/services/history.py` - search methods
- `src/widgets/history_list.py` - search UI (need to check if exists)

**Estimate**: Medium, 2-3 hours

---

## Phase 4: Settings & Polish (Medium Priority)

### 4.1 Settings Panel
**Goal**: Configurable preferences

**Implementation**:
- [ ] **CP4.1.1**: Create settings storage (`~/.config/claude-companion/settings.json`)
- [ ] **CP4.1.2**: Create `SettingsService` singleton
- [ ] **CP4.1.3**: Create `SettingsWindow` with sections:
  - Editor (font family, font size, tab size, theme)
  - File Tree (show hidden, ignore patterns)
  - Git (default author, SSH key path)
  - Terminal (font, color scheme)
- [ ] **CP4.1.4**: Add "Preferences" menu item or button
- [ ] **CP4.1.5**: Apply settings on change (live preview)

**Files to create**:
- `src/services/settings_service.py`
- `src/widgets/settings_window.py`

**Estimate**: Medium, 3-4 hours

---

### 4.2 Keyboard Shortcuts
**Goal**: Comprehensive keyboard navigation

**Implementation**:
- [ ] **CP4.2.1**: Document all existing shortcuts
- [ ] **CP4.2.2**: Add missing shortcuts:
  - Ctrl+P: File search
  - Ctrl+Shift+F: Content search
  - Ctrl+G: Go to line
  - Ctrl+`: Toggle terminal
  - Ctrl+B: Toggle sidebar
  - Ctrl+Tab: Next tab
  - Ctrl+W: Close tab
- [ ] **CP4.2.3**: Add shortcuts help dialog (Ctrl+?)
- [ ] **CP4.2.4**: Make shortcuts configurable (optional)

**Files to modify**:
- `src/project_window.py` - add action shortcuts
- `src/widgets/shortcuts_dialog.py` - new file

**Estimate**: Small-Medium, 2 hours

---

### 4.3 Error Handling
**Goal**: Consistent error display and logging

**Implementation**:
- [ ] **CP4.3.1**: Create `ErrorService` for centralized error handling
- [ ] **CP4.3.2**: Create error dialog template
- [ ] **CP4.3.3**: Add file logging (`~/.local/share/claude-companion/logs/`)
- [ ] **CP4.3.4**: Replace all bare `except: pass` with proper handling
- [ ] **CP4.3.5**: Add "Report bug" link in error dialogs

**Files to create**:
- `src/services/error_service.py`
- `src/widgets/error_dialog.py`

**Estimate**: Medium, 2-3 hours

---

## Phase 5: Advanced Features (Lower Priority)

### 5.1 Git Stash Support
- [ ] List stashes
- [ ] Create stash (with message)
- [ ] Apply/pop stash
- [ ] Drop stash

**Estimate**: Small, 1-2 hours

---

### 5.2 TODO Notes (v0.6 Milestone)
**Goal**: Project-local notes and todos

- [ ] Create notes storage format
- [ ] Notes panel in sidebar
- [ ] Markdown editor for notes
- [ ] Todo checkbox support
- [ ] Link notes to files/commits

**Estimate**: Medium-Large, 4-5 hours

---

### 5.3 Testing Infrastructure
- [ ] Set up pytest
- [ ] Add unit tests for services
- [ ] Add integration tests for git operations
- [ ] Set up CI/CD (GitHub Actions)

**Estimate**: Medium, 3-4 hours

---

## Implementation Order Recommendation

Based on dependencies and impact:

### Sprint 1: Foundation
1. **1.1 Toast System** (required by everything else for feedback)
2. **1.2 File System Watching** (high user impact)
3. **1.3 File Tree Filtering** (can be done with 1.2)

### Sprint 2: Git Core
4. **2.1 Branch Management** (most requested)
5. **2.2 Commit Details View** (your priority)
6. **2.3 Improved Diff View** (enhances 2.2)

### Sprint 3: Search
7. ✅ **3.1 File Search** (Ctrl+P, very useful) - DONE
8. **4.2 Keyboard Shortcuts** (while adding Ctrl+P)
9. ✅ **3.2 Content Search** (Ctrl+Shift+F with replace) - DONE

### Sprint 4: Polish
10. **4.1 Settings Panel**
11. **4.3 Error Handling**
12. **2.4 Pull with Merge** (complex, can wait)

### Later
- 3.3 Session History Search
- 5.1 Git Stash
- 5.2 TODO Notes
- 5.3 Testing

---

## UI Unification ✅ COMPLETED

### Sidebar Structure: Files / Git / Claude

**Goal**: Unified navigation pattern - sidebar for browsing, main area for content

**Previous structure**:
- Sidebar: Files / Git tabs
- Main area: Pinned "History" tab + other tabs

**New structure**:
- Sidebar: Files / Git / Claude tabs (3 top-level tabs)
- Main area: Only content tabs (terminals, editors, session details, commit details)

**Implementation**:
- [x] Created `ClaudeHistoryPanel` widget for sidebar
- [x] Added "Claude" as third tab in sidebar stack
- [x] Sessions list with auto-refresh (5s) and selection preservation
- [x] Click session → show in main area (reuses single tab, like commits)
- [x] Removed pinned History tab from main area

**Layout**:
```
Sidebar                         │  Main Area (Tabs)
┌─────────────────────────────┐ │ ┌────────────────────────────┐
│ [Files] [Git] [Claude]      │ │ │ [Session] [Terminal] [file]│
├─────────────────────────────┤ │ ├────────────────────────────┤
│                             │ │ │                            │
│ Claude tab:                 │ │ │  Session/Commit detail     │
│ ┌─────────────────────────┐ │ │ │  (reuses single tab)       │
│ │ Sessions          [↻]   │ │ │ │                            │
│ │ ○ Today 14:30      [5]  │ │ │ │                            │
│ │ ○ Yesterday 10:00  [12] │ │ │ │                            │
│ └─────────────────────────┘ │ │ │                            │
└─────────────────────────────┘ │ └────────────────────────────┘
```

**Files created/modified**:
- `src/widgets/claude_history_panel.py` - new file
- `src/project_window.py` - added Claude tab, removed History tab

---

## Decisions Made (2025-12-12)

1. **File monitoring**: Full recursive tree with progress indicator, background thread
2. **Gitignore**: Use `pathspec` library for reliability
3. **Fuzzy search**: TBD (will decide when implementing)
4. **Diff view**: Unified diff with file navigation (no split view needed)
5. **Merge conflicts**: Basic - show markers in editor, user resolves manually
6. **Settings storage**: JSON file (`~/.config/claude-companion/settings.json`)
7. **UI pattern**: Sidebar for navigation (Files/Git/Claude), main area for content only

---

## Known Issues / Bugs

- [x] **Blurry icons in file tree** - Fixed by using `Gtk.Image.new_from_gicon()` instead of `new_from_paintable()`. GIcon allows GTK to render SVG at requested pixel size.

## TODO (Minor Features)

- [x] **Delete file/folder** - Added delete button in file tree header with confirmation dialog. Also closes tabs for deleted files.

---

## Notes

- All estimates are rough and assume familiarity with GTK4/libadwaita
- Checkpoints marked with `[ ]` will be updated to `[x]` as completed
- This plan is a living document - priorities may shift based on user feedback
