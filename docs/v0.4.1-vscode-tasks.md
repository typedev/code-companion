# v0.4.1 Plan: VSCode Tasks Support

## Goal

Add support for `.vscode/tasks.json` — display tasks in sidebar and run them with one click.

## UI Design

```
┌─────────────────┐
│ Files           │
│ ├── src/        │
│ └── ...         │
├─────────────────┤
│ Tasks        ⟳  │
│ [▶] Run App     │
│ [▶] Test        │
│ [▶] Build       │
└─────────────────┘
```

- Tasks panel appears below Files in sidebar
- Only shown if `.vscode/tasks.json` exists
- Auto-refresh when file is created/modified
- Click task → opens Terminal tab and runs command
- If task has inputs → show dialog first

## tasks.json Format Support

### Basic task:
```json
{
  "version": "2.0.0",
  "tasks": [
    {
      "label": "Run App",
      "type": "shell",
      "command": "uv run python main.py"
    }
  ]
}
```

### With variables:
```json
{
  "command": "${workspaceFolder}/scripts/build.sh"
}
```

Supported variables:
- `${workspaceFolder}` — project root path
- `${file}` — currently open file (if any)
- `${fileBasename}` — filename without path

### With inputs (prompts):
```json
{
  "tasks": [
    {
      "label": "Run with args",
      "command": "python main.py ${input:args}"
    }
  ],
  "inputs": [
    {
      "id": "args",
      "type": "promptString",
      "description": "Script arguments",
      "default": ""
    }
  ]
}
```

## File Structure

```
src/
├── widgets/
│   └── tasks_panel.py    # NEW: Tasks panel widget
├── services/
│   └── tasks_service.py  # NEW: Parse tasks.json, variable substitution
└── project_window.py     # Update: add TasksPanel to sidebar
```

## Checkpoints

### Checkpoint 1: Basic tasks display
- [ ] Create TasksService to parse tasks.json
- [ ] Create TasksPanel widget
- [ ] Add to sidebar in ProjectWindow
- [ ] Show/hide based on file existence

### Checkpoint 2: Run tasks
- [ ] Click task → open Terminal tab
- [ ] Run command in terminal
- [ ] Variable substitution (${workspaceFolder})

### Checkpoint 3: File monitoring
- [ ] Watch .vscode/tasks.json for changes
- [ ] Auto-refresh panel when file created/modified/deleted

### Checkpoint 4: Input prompts
- [ ] Parse inputs section
- [ ] Show dialog for ${input:id} variables
- [ ] Support promptString type
- [ ] Support default values

## Implementation Details

### TasksService

```python
@dataclass
class Task:
    label: str
    command: str
    type: str = "shell"
    group: str | None = None

class TasksService:
    def __init__(self, project_path: Path):
        self.project_path = project_path
        self.tasks_file = project_path / ".vscode" / "tasks.json"

    def get_tasks(self) -> list[Task]:
        """Parse tasks.json and return task list."""

    def substitute_variables(self, command: str, context: dict) -> str:
        """Replace ${var} placeholders."""

    def get_inputs(self) -> dict[str, Input]:
        """Get input definitions."""
```

### TasksPanel

```python
class TasksPanel(Gtk.Box):
    __gsignals__ = {
        "task-run": (GObject.SignalFlags.RUN_FIRST, None, (str, str)),  # label, command
    }

    def __init__(self, project_path: str):
        self.service = TasksService(project_path)
        self._setup_file_monitor()
        self.refresh()
```

### Input Dialog

```python
def _show_input_dialog(self, input_def: Input, callback):
    dialog = Adw.AlertDialog()
    dialog.set_heading(input_def.description or f"Enter {input_def.id}")

    entry = Gtk.Entry()
    entry.set_text(input_def.default or "")
    dialog.set_extra_child(entry)

    dialog.add_response("cancel", "Cancel")
    dialog.add_response("ok", "OK")
    dialog.connect("response", lambda d, r: callback(entry.get_text() if r == "ok" else None))
    dialog.present(self)
```

## Progress

- Started: 2025-01-XX
- Current checkpoint: 4 (all complete)
- Status: COMPLETED

All checkpoints implemented:
- [x] TasksService parses tasks.json with JSONC support
- [x] TasksPanel widget displays tasks in sidebar
- [x] Click task opens terminal tab and runs command
- [x] File monitoring auto-refreshes on tasks.json changes
- [x] Input prompts via Adw.AlertDialog for ${input:id} variables
